---
import Layout from '../../../layouts/Layout.astro';
import TicketSelection from '../../../components/react/TicketSelection.tsx';
import { getAuthenticatedUser } from '../../../lib/auth';

export const prerender = false;

const user = getAuthenticatedUser(Astro.cookies);
if (!user) {
  const returnUrl = Astro.url.pathname + Astro.url.search;
  return Astro.redirect(`/login?returnUrl=${encodeURIComponent(returnUrl)}`);
}

const { showId, timetableId } = Astro.params;

if (
  !showId ||
  !timetableId ||
  isNaN(Number(showId)) ||
  isNaN(Number(timetableId))
) {
  return new Response('IDs inválidos o faltantes', { status: 400 });
}

let showDetails = null;
let error = null;
let ticketTypes = [];

try {
  try {
    const typesResponse = await fetch('http://localhost:3000/api/ticketTypes');
    if (typesResponse.ok) {
      const typesData = await typesResponse.json();
      ticketTypes = typesData.data || [];
    } else {
      console.error('Error fetching ticket types:', typesResponse.statusText);
    }
  } catch (err) {
    console.error('Error fetching ticket types:', err);
  }

  const showResponse = await fetch(`http://localhost:3000/api/show/${showId}`);
  if (!showResponse.ok) {
    const errorData = await showResponse.json().catch(() => ({}));
    throw new Error(
      errorData.message ||
        `Error ${showResponse.status} al obtener detalles de la función.`
    );
  }

  const showData = await showResponse.json();
  if (!showData.data) {
    throw new Error('Respuesta del servidor no contiene datos de la función.');
  }
  const currentShow = showData.data;

  let soldTickets = 0;
  try {
    const countResponse = await fetch(
      `http://localhost:3000/api/tickets/count/by-timetable/${timetableId}`
    );
    if (countResponse.ok) {
      const countData = await countResponse.json();
      soldTickets = countData.data?.soldTicketsCount ?? 0;
    } else {
      console.warn('No se pudo obtener el conteo de tickets vendidos.');
    }
  } catch (err) {
    console.error('Error fetching ticket count:', err);
  }

  // Calculo de asientos disponibles a la hora de seleccionar cantidad de entradas
  const timetable = currentShow.timetables?.find(
    (tt: any) => tt.id === Number(timetableId)
  );

  const totalCapacity = currentShow.showRoom?.capacity;
  let availableCapacity = 0;

  if (typeof totalCapacity === 'number' && totalCapacity > 0) {
    availableCapacity = Math.max(0, totalCapacity - soldTickets);
  }

  if (
    timetable &&
    currentShow.showRoom &&
    totalCapacity !== undefined &&
    currentShow.showCat &&
    currentShow.showMovie
  ) {
    showDetails = {
      movieName: currentShow.showMovie.name || 'Película Desconocida',
      roomName: currentShow.showRoom.name || 'Sala Desconocida',
      date: currentShow.date,
      time: timetable.time.substring(0, 5),
      format: currentShow.showCat.description || '',
      variant: currentShow.variant || '',
      basePrice: currentShow.showCat.price || 0,
      showId: currentShow.id,
      timetableId: timetable.id,
      availableCapacity: availableCapacity,
    };
  } else {
    let missingData = [];
    if (!timetable) missingData.push('horario específico');
    if (!currentShow.showRoom) missingData.push('información de la sala');
    if (currentShow.showRoom && totalCapacity === undefined)
      missingData.push('capacidad de la sala');
    if (!currentShow.showCat) missingData.push('categoría de la función');
    if (!currentShow.showMovie) missingData.push('información de la película');

    throw new Error(`Datos incompletos: falta ${missingData.join(', ')}.`);
  }
} catch (err: any) {
  console.error('Error en purchase page:', err);
  error = err.message || 'No se pudieron cargar los detalles de la función.';
  showDetails = null;
}
---

<Layout title="Seleccionar Entradas">
  <main class="purchase-container container">
    <h1>Comprar Entradas</h1>
    {error && <p class="error-message">Error: {error}</p>}
    {
      !error && showDetails && showDetails.availableCapacity > 0 && (
        <TicketSelection
          client:load
          showDetails={showDetails}
          ticketTypes={ticketTypes}
        />
      )
    }
    {
      !error && showDetails && showDetails.availableCapacity === 0 && (
        <p class="error-message" style="margin-top: 2rem;">
          ¡Lo sentimos! Esta función ya no tiene asientos disponibles.
        </p>
      )
    }
    {
      !error && !showDetails && !error && (
        <p>Cargando detalles de la función...</p>
      )
    }
  </main>
</Layout>

<style>
  .purchase-container {
    padding-top: 2rem;
    padding-bottom: 4rem;
    color: black;
  }
  .purchase-container h1 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2.5rem;
  }
  .error-message {
    color: #d9534f;
    background-color: #f2dede;
    border: 1px solid #ebccd1;
    padding: 1rem;
    border-radius: 4px;
    text-align: center;
    font-weight: bold;
    margin: 2rem auto;
    max-width: 700px;
  }
</style>
