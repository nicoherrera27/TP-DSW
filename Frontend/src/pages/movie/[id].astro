---
import '../../styles/movie-id.css';
import Layout from '../../layouts/Layout.astro';
import { tmdbService } from '../../services/tmdbService';
import type { TMDBVideo } from '../../types/movies';
export const prerender = false;

const { id } = Astro.params;
if (!id) {
  return Astro.redirect('/404');
}

const movie = await tmdbService.getMovieDetails(Number(id));
const videosResponse = await tmdbService.getMovieVideos(Number(id));
const trailer =
  videosResponse.results.find(
    (video: TMDBVideo) =>
      video.site === 'YouTube' && video.type === 'Trailer' && video.official
  ) ||
  videosResponse.results.find(
    (video: TMDBVideo) => video.site === 'YouTube' && video.type === 'Trailer'
  );
const posterUrl = movie.poster_path
  ? tmdbService.getImageUrl(movie.poster_path)
  : '/placeholder-movie.png';
const backdropUrl = movie.backdrop_path
  ? tmdbService.getImageUrl(movie.backdrop_path, 'large')
  : '';

function getFormattedDate(dateStr: string) {
  try {
    const dateObj = new Date(`${dateStr}T12:00:00Z`);
    const formatted = dateObj.toLocaleDateString('es-AR', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      timeZone: 'UTC',
    });
    return formatted.charAt(0).toUpperCase() + formatted.slice(1);
  } catch (e) {
    return dateStr;
  }
}

let groupedShowsByDate = new Map<string, any[]>();

try {
  const showsResponse = await fetch(
    `http://localhost:3000/api/show/by-movie/${id}`
  );
  if (showsResponse.ok) {
    const showsData = await showsResponse.json();

    const sortedShows = (showsData.data || []).sort((a: any, b: any) =>
      a.date.localeCompare(b.date)
    );

    sortedShows.forEach((show: any) => {
      if (
        show.timetables &&
        Array.isArray(show.timetables) &&
        show.timetables.length > 0
      ) {
        const dateKey = getFormattedDate(show.date);
        if (!groupedShowsByDate.has(dateKey)) {
          groupedShowsByDate.set(dateKey, []);
        }
        groupedShowsByDate.get(dateKey)!.push(show);
      }
    });
  } else {
    console.error('Error fetching shows:', showsResponse.statusText);
  }
} catch (error) {
  console.error('Error fetching or processing shows:', error);
}
---

<Layout title={movie.title}>
  <div
    class="backdrop"
    style={`background-image: linear-gradient(to right, rgba(10, 25, 41, 1) 20%, rgba(10, 25, 41, 0.7) 50%, rgba(10, 25, 41, 1) 100%), url(${backdropUrl})`}
  >
  </div>
  <main class="movie-detail-container">
    <div class="detail-grid">
      <div class="main-content">
        <h1>{movie.title}</h1>
        <div class="meta-info">
          <span>{movie.runtime} min</span><span>•</span>
          <span>{movie.genres.map((g) => g.name).join(', ')}</span><span>•</span
          >
          <span>{new Date(movie.release_date).getFullYear()}</span>
        </div>
        <p class="synopsis">{movie.overview}</p>

        {
          trailer && (
            <div class="trailer-container">
              <h3>Official Trailer</h3>
              <iframe
                src={`https://www.youtube.com/embed/${trailer.key}`}
                title="YouTube video player"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              />
            </div>
          )
        }
      </div>

      <aside class="sidebar-content">
        <img
          src={posterUrl}
          alt={`Póster de ${movie.title}`}
          class="detail-poster"
        />
        <div class="data-sheet">
          <h4>Film Technical Specifications</h4>
          <ul>
            <li><strong>Original Title:</strong> {movie.original_title}</li>
            <li>
              <strong>Release Date:</strong>
              {
                new Date(movie.release_date).toLocaleDateString('es-AR', {
                  timeZone: 'UTC',
                })
              }
            </li>
            <li><strong>Duration:</strong> {movie.runtime} min</li>
            <li>
              <strong>Rating:</strong>
              {movie.vote_average.toFixed(1)} / 10
            </li>
          </ul>
        </div>
      </aside>
    </div>

    <div class="showtimes-container">
      <h2>Available Showtimes</h2>
      {
        groupedShowsByDate.size > 0 ? (
          <div class="cinema-section">
            <h3>CineVerse Rosario</h3>

            {Array.from(groupedShowsByDate.entries()).map(
              ([date, showsOnThisDate]) => (
                <div
                  class="date-group"
                  style="border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem; margin-bottom: 0.5rem;"
                >
                  <h5 style="color: #666; font-weight: 600; font-size: 0.9rem; margin: 0.75rem 0; text-transform: uppercase; letter-spacing: 0.5px;">
                    {date}
                  </h5>

                  {showsOnThisDate.map((show) => {
                    const format = show.showCat?.description || 'Formato';
                    const variant = show.variant || 'Idioma';

                    return (
                      <div
                        class="format-section"
                        style="padding: 0.25rem 0 0.75rem 0; border: none;"
                      >
                        <h4 style="color: #333; font-weight: normal; margin-bottom: 0.75rem;">
                          {format} - {variant}
                        </h4>

                        <div class="times-grid">
                          {show.timetables
                            .sort((a: any, b: any) =>
                              a.time.localeCompare(b.time)
                            )
                            .map((tt: any) => (
                              <a
                                href={`/purchase/${show.id}/${tt.id}`}
                                class="time-button"
                              >
                                {tt.time.substring(0, 5)}
                              </a>
                            ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )
            )}
          </div>
        ) : (
          <p>No shows scheduled for this movie.</p>
        )
      }
    </div>
  </main>
</Layout>
