---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/astro/Header.astro';
import { tmdbService } from '../../services/tmdbService';
import type { TMDBVideo } from '../../types/movies';

export const prerender = false;

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/404');
}

const movie = await tmdbService.getMovieDetails(Number(id));
const videosResponse = await tmdbService.getMovieVideos(Number(id));

const trailer =
  videosResponse.results.find(
    (video: TMDBVideo) =>
      video.site === 'YouTube' && video.type === 'Trailer' && video.official
  ) ||
  videosResponse.results.find(
    (video: TMDBVideo) => video.site === 'YouTube' && video.type === 'Trailer'
  );

const posterUrl = movie.poster_path
  ? tmdbService.getImageUrl(movie.poster_path)
  : '/placeholder-movie.png';
const backdropUrl = movie.backdrop_path
  ? tmdbService.getImageUrl(movie.backdrop_path, 'large')
  : '';
---

<Layout title={movie.title}>
  <Header />
  <div
    class="backdrop"
    style={`background-image: linear-gradient(to right, rgba(10, 25, 41, 1) 20%, rgba(10, 25, 41, 0.7) 50%, rgba(10, 25, 41, 1) 100%), url(${backdropUrl})`}
  >
  </div>
  <main class="movie-detail-container">
    <div class="detail-grid">
      <div class="main-content">
        <h1>{movie.title}</h1>
        <div class="meta-info">
          <span>{movie.runtime} min</span>
          <span>•</span>
          <span>{movie.genres.map((g) => g.name).join(', ')}</span>
          <span>•</span>
          <span>{new Date(movie.release_date).getFullYear()}</span>
        </div>
        <p class="synopsis">{movie.overview}</p>

        {
          trailer && (
            <div class="trailer-container">
              <h3>Trailer Oficial</h3>
              <iframe
                src={`https://www.youtube.com/embed/${trailer.key}`}
                title="YouTube video player"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              />
            </div>
          )
        }
      </div>

      <aside class="sidebar-content">
        <img
          src={posterUrl}
          alt={`Póster de ${movie.title}`}
          class="detail-poster"
        />
        <div class="data-sheet">
          <h4>Ficha Técnica</h4>
          <ul>
            <li><strong>Título Original:</strong> {movie.original_title}</li>
            <li>
              <strong>Estreno:</strong>
              {
                new Date(movie.release_date).toLocaleDateString('es-AR', {
                  timeZone: 'UTC',
                })
              }
            </li>
            <li><strong>Duración:</strong> {movie.runtime} min</li>
            <li>
              <strong>Calificación:</strong>
              {movie.vote_average.toFixed(1)} / 10
            </li>
          </ul>
        </div>
      </aside>
    </div>
  </main>
</Layout>
